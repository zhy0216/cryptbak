# Cryptbak

一个简单的文件加密备份工具，使用 [Zig](https://ziglang.org/) 编写。

本项目在 [Windsurf](https://www.windsurfrs.com/) 的帮助下开发，且仅在 Mac 上进行过测试。请自行承担使用风险。

## 功能

- 加密备份文件
- 增量备份（只加密新文件或已修改的文件）
- 基于内容的去重（相同内容的文件只备份一次）
- 安全的密码派生密钥
- 解密还原
- 支持空目录和复杂的目录结构
- 完整的文件元数据处理
- 通过文件名哈希增强的隐私保护

## 更新日志

### v0.0.4

- **监听模式**：添加新的监听模式（`-t`）持续监控源目录的变化
- **最小备份周期**：添加可配置的最小备份间隔时间（`--mt` 选项，默认90秒）

### v0.0.3

- **基于内容的去重**：使用文件内容的SHA-256哈希值作为备份文件名，自动实现相同内容文件的去重
- **智能删除**：删除备份文件时检查是否还有其他文件引用相同内容，避免误删

### v0.0.2 

- **安全性增强**：所有加密文件现在存储在备份目录的`content`子文件夹中
- **隐私保护**：使用文件路径的MD5哈希作为加密文件名，防止原始文件名泄露
- **完全隐藏目录结构**：不再在备份中创建原始目录结构，所有结构信息仅保存在加密的元数据中
- **改进的恢复过程**：解密时首先根据元数据创建完整目录结构，然后再解密文件
- **更严格的隐私保护**：备份目录中不再包含任何可识别的原始文件或目录信息

### v0.0.1

- 初始版本
- 基本的文件加密备份功能
- 增量备份支持
- 密码派生密钥支持
- 解密还原功能

## 要求

- Zig 0.14.0 或更高版本

## 编译

```bash
git clone https://github.com/yourusername/cryptbak.git
cd cryptbak
zig build
```

编译后的可执行文件将位于 `./zig-out/bin/cryptbak`。

## 使用方法

### 加密备份

```bash
./cryptbak source_folder output_folder -p password
```

### 解密还原

```bash
./cryptbak source_folder output_folder -d -p password
```

## 工作原理

1. **加密模式**：
   - 扫描源文件夹中的所有文件
   - 计算每个文件的SHA-256哈希值
   - 与上次备份的元数据进行比较（如果存在）
   - 只加密新增或修改过的文件
   - 使用文件内容的哈希值作为备份文件名，自动实现去重
   - 删除文件时检查是否还有其他文件引用相同内容
   - 更新元数据
   - 将加密后的文件以内容哈希值作为文件名存储在content目录中

2. **解密模式**：
   - 读取加密文件夹中的元数据
   - 根据元数据创建原始目录结构
   - 从content目录中获取加密文件并解密到对应位置

3. **元数据**：
   - 存储在输出文件夹的`.cryptbak.meta`文件中
   - 包含每个文件的路径、修改时间、大小和哈希值
   - 元数据本身也会被加密，具有两部分结构：
     - 非加密的头部（版本、时间戳、文件数量）
     - 加密的文件详情部分

## 安全说明

- 使用ChaCha20IETF流加密算法
- 密钥从密码派生，使用PBKDF2算法
- 每个文件使用唯一的随机nonce进行加密
- 备份中不暴露任何原始文件名或目录结构
